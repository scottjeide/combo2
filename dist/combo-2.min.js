/*! Combo2 0.8
 * Copyright (c) 2016 Stephen Rolfe Nielsen
 *
 * https://github.com/srolfe26/combo2
 *
 * @license MIT 2016 Stephen Rolfe Nielsen
 */ 

Array.prototype.forEach||(Array.prototype.forEach=function(e,t){var n,i;if(null==this)throw new TypeError(" this is null or not defined");var r=Object(this),a=r.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(n=t),i=0;a>i;){var o;i in r&&(o=r[i],e.call(n,o,i,r)),i++}}),function(){"use strict";var e=Array.prototype.slice;try{e.call(document.documentElement)}catch(t){Array.prototype.slice=function(t,n){if(n="undefined"!=typeof n?n:this.length,"[object Array]"===Object.prototype.toString.call(this))return e.call(this,t,n);var i,r,a=[],o=this.length,l=t||0;l=l>=0?l:Math.max(0,o+l);var s="number"==typeof n?Math.min(n,o):o;if(0>n&&(s=o+n),r=s-l,r>0)if(a=new Array(r),this.charAt)for(i=0;r>i;i++)a[i]=this.charAt(l+i);else for(i=0;r>i;i++)a[i]=this[l+i];return a}}}(),Array.prototype.map||(Array.prototype.map=function(e,t){var n,i,r;if(null==this)throw new TypeError(" this is null or not defined");var a=Object(this),o=a.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(n=t),i=new Array(o),r=0;o>r;){var l,s;r in a&&(l=a[r],s=e.call(n,l,r,a),i[r]=s),r++}return i}),Array.prototype.filter||(Array.prototype.filter=function(e){"use strict";if(void 0===this||null===this)throw new TypeError;var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError;for(var i=[],r=arguments.length>=2?arguments[1]:void 0,a=0;n>a;a++)if(a in t){var o=t[a];e.call(r,o,a,t)&&i.push(o)}return i}),function(){if(!Object.defineProperty||!function(){try{return Object.defineProperty({},"x",{}),!0}catch(e){return!1}}()){var e=Object.defineProperty;Object.defineProperty=function(t,n,i){if(e)try{return e(t,n,i)}catch(r){}if(t!==Object(t))throw TypeError("Object.defineProperty called on non-object");return Object.prototype.__defineGetter__&&"get"in i&&Object.prototype.__defineGetter__.call(t,n,i.get),Object.prototype.__defineSetter__&&"set"in i&&Object.prototype.__defineSetter__.call(t,n,i.set),"value"in i&&(t[n]=i.value),t}}}(),!function(e,t,n){"undefined"!=typeof module&&module.exports?module.exports=n():e[t]=n()}(this,"verge",function(){function e(){return{width:c(),height:d()}}function t(e,t){var n={};return t=+t||0,n.width=(n.right=e.right+t)-(n.left=e.left-t),n.height=(n.bottom=e.bottom+t)-(n.top=e.top-t),n}function n(e,n){return e=e&&!e.nodeType?e[0]:e,e&&1===e.nodeType?t(e.getBoundingClientRect(),n):!1}function i(t){t=null==t?e():1===t.nodeType?n(t):t;var i=t.height,r=t.width;return i="function"==typeof i?i.call(t):i,r="function"==typeof r?r.call(t):r,r/i}var r={},a="undefined"!=typeof window&&window,o="undefined"!=typeof document&&document,l=o&&o.documentElement,s=a.matchMedia||a.msMatchMedia,u=s?function(e){return!!s.call(a,e).matches}:function(){return!1},c=r.viewportW=function(){var e=l.clientWidth,t=a.innerWidth;return t>e?t:e},d=r.viewportH=function(){var e=l.clientHeight,t=a.innerHeight;return t>e?t:e};return r.mq=u,r.matchMedia=s?function(){return s.apply(a,arguments)}:function(){return{}},r.viewport=e,r.scrollX=function(){return a.pageXOffset||l.scrollLeft},r.scrollY=function(){return a.pageYOffset||l.scrollTop},r.rectangle=n,r.aspect=i,r.inX=function(e,t){var i=n(e,t);return!!i&&i.right>=0&&i.left<=c()},r.inY=function(e,t){var i=n(e,t);return!!i&&i.bottom>=0&&i.top<=d()},r.inViewport=function(e,t){var i=n(e,t);return!!i&&i.bottom>=0&&i.right>=0&&i.top<=d()&&i.left<=c()},r}),jQuery.extend(verge);var Wui=Wui||{};Wui.id=function(e){return e=e||"wui",e+"-"+(Wui.idCounter=~~++Wui.idCounter)},Wui.maxZ=function(){var e=arguments[0]instanceof jQuery?arguments[0][0]:arguments[0],t=$("body *"),n=t.length<2500?t:$('body > *, [style*="z-index"]'),i=Math.max.apply(null,$.map(n,function(t){return"static"!=$(t).css("position")&&t!=e?parseInt($(t).css("z-index"))||0:void 0}));return($.isNumeric(i)?i:0)+1},Wui.isPercent=function(e){return e=String(e),-1!=e.indexOf("%")&&$.isNumeric(parseFloat(e))},Wui.getScrollbarWidth=function(){var e,t;return void 0===Wui.scrollbarWidth&&(e=$('<div style="width:50px;height:50px;overflow:auto"><div/></div>').appendTo("body"),t=e.children(),Wui.scrollbarWidth=t.innerWidth()-t.height(99).innerWidth(),e.remove()),Wui.scrollbarWidth},Wui.getStylesForElement=function(e){var t={};Array.prototype.slice.call(document.styleSheets).forEach(function(n){n.rules&&Array.prototype.slice.call(n.rules).forEach(function(i){n.rule&&i.selectorText.split(",").forEach(function(n){if(e.matches(n))for(var r=0;r<i.style.length;++r){var a=i.style[r];t[a]=i.style[a]}})})});var n=e.style;return $.each(n,function(e,i){t[i]=n[i]}),t},Wui.parseSelect=function(e){var t=[],n=$(e).find("option");return n.each(function(e,n){var i=$(n),r=i.parent("optgroup"),a=r.prop("disabled")||i.prop("disabled");t.push({element:i,index:e,value:a?null:i.val(),label:i.text(),optgroup:r.attr("label")||"",disabled:a})}),t},Wui.percentToPixels=function(e,t,n){var i=e.parent(),r=i[0]===$(window)[0]||i[0]===$("html")[0]||i[0]===$("body")[0],a=r?"height"==n?$.viewportH():$.viewportW():i[n]();return Math.floor(parseFloat(t)/100*a)},Wui.positionItem=function(e,t){var n,i=e[0].getBoundingClientRect(),r=i.top,a=t.outerWidth(),o=i.top,l=$.viewportH()-o-e.outerHeight(),s=l>o,u=i.left+e.outerWidth()-a>0;t.css({"max-height":(s?l:o)-15}),n=t.outerHeight(),r=s?r+e.outerHeight():r-($.isNumeric(n)?n:t.outerHeight()),t.css({left:u?i.left+e.outerWidth()-a:i.left,top:r,position:"fixed",zIndex:Wui.maxZ(t)})},Wui.unwrapData=function(e){var t=this,n=t.hasOwnProperty("dataContainer")?t.dataContainer:Wui.Data.prototype.dataContainer,i=t.hasOwnProperty("totalContainer")?t.totalContainer:Wui.Data.prototype.totalContainer,r=n&&e[n]?e[n]:e,a=i&&e[i]?e[i]:r.length;return{data:r,total:a}},Wui.Data=function(e){$.extend(this,{data:[],identity:null,name:null,params:{},url:null,ajaxConfig:{},total:0},e)},Wui.Data.prototype={dataContainer:null,totalContainer:null,dataChanged:function(){},dataEach:function(e){for(var t=0;t<this.data.length&&e(this.data[t],t)!==!1;t++);return!0},loadData:function(){var e=this,t=$.extend({data:e.params,dataType:"json",success:function(){e.success.apply(e,arguments)},error:function(){e.failure.apply(e,arguments)}},e.ajaxConfig),n=e.setParams.apply(e,arguments),i=e.beforeLoad.apply(e,arguments);return n!==!1&&i!==!1?(e.lastRequest&&4!=e.lastRequest.readyState&&e.lastRequest.abort(),e.lastRequest=$.ajax(e.url,t),e.lastRequest):$.Deferred().reject()},setParams:function(e){e&&"object"==typeof e&&$.extend(this.params,e)},setData:function(e,t){var n=this;n.beforeSet(e),n.data=n.processData(e),n.total=$.isNumeric(t)?t:n.data?n.data.length:0,n.fireDataChanged()},fireDataChanged:function(){var e=this,t=e.name||"w121-data";e.dataChanged(e.data),$(document).trigger($.Event("datachanged."+t),[t,e]).trigger($.Event("datachanged"),[t,e]),e.afterSet(e.data)},beforeLoad:function(){},afterSet:function(){},beforeSet:function(){},success:function(e){var t=this,n=Wui.unwrapData.call(t,e);t.onSuccess(e),t.setData(n.data,n.total)},onSuccess:function(){},onFailure:function(){},failure:function(e){this.onFailure(e)},processData:function(e){return e},push:function(){var e=Array.prototype.push.apply(this.data||(this.data=[]),arguments);return this.total=this.data.length,this.fireDataChanged(),e},splice:function(){var e=Array.prototype.splice.apply(this.data||(this.data=[]),arguments);return this.total=this.data.length,this.fireDataChanged(),e}},Wui.Smarty=function(e){$.extend(this,{html:"",compiled:null,build:[],__s:""},e)},Wui.Smarty.prototype={applyFlags:function(e,t){function n(e,t){var n=i.build[i.build.length-1];n.fn=n.fn||[],n.params=n.params||[],n.fn.push(e),n.params.push($.extend(!0,[],t))}for(var i=this,r=0;r<t.length;r++){for(var a,o=t[r].split(":"),l=1;l<o.length;l++)o[l]=i.trimSpecial(o[l],"\"'");a=o.shift(),"function"==a?(n("js_function",o),e=i.js_function.apply(i,o)):("default"==a&&(a="defaultVal"),"function"!=typeof i[a]?new Error("wui-smarty.js - Unsupported flag: '"+a+"'."):(n(a,o),o.splice(0,0,e),e=i[a].apply(i,o)))}return e},capitalize:function(e){return String(e).replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},chain:function(e,t){var n=this;return t.splice(0,0,n.__s),n.__s=n[e].apply(n,t),n},compile:function(){function e(e){return"['"+e.join("','")+"']"}for(var t=this,n='var me = this, retString = "";',i=0;i<t.build.length;i++){var r=t.build[i];if($.isPlainObject(r)){if(r.key.length>0?n+="me.__s = me.lookup(rec, '"+r.key+"');":"undefined"!=typeof r.fn&&(n+="me.__s = me."+r.fn.shift()+".apply(me, "+e(r.params.shift())+");"),"undefined"!=typeof r.fn&&r.fn.length>0){n+="me";for(var a=0;a<r.fn.length;a++)n+=".chain('"+r.fn[a]+"',"+e(r.params[a])+")";n+=";"}n+="retString += me.__s;"}else n+="retString += '"+t.escape(r,"javascript")+"';"}return n+="return retString;",Function.apply(null,["rec",n])},defaultVal:function(e,t){return e?e:t},escapeHTML:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},escapeJS:{"\\":"\\\\","'":"\\'",'"':'\\"',"\r":"\\r","\n":"\\n","</":"</"},escape:function(e,t,n){n=n||!1;var i=this,r={html:function(){var t=i.escapeHTML,r=n?i.invert(t):t,a=new RegExp("["+i.getKeys(r).join("").replace(/\//,"\\/")+"]","g");return String(e).replace(a,function(e){return r[e]}).replace(a,function(e){return r[e]})},javascript:function(){var t=i.escapeJS,r=n?i.invert(t):t,a=n?/\\\\|\'|\\"|\\r|\\n|<\//g:/<\/|"|'|\\|\n|\r/g;return String(e).replace(a,function(e){return r[e]})},json:function(){var t=n?"parse":"stringify";return JSON[t](e)},url:function(){var t=n?"decodeURI":"encodeURI";return JSON[t](e)}};return"function"==typeof r[t]?r[t]():r.html()},getKeys:function(e){var t=[];return $.isPlainObject(e)&&$.each(e,function(e){t.push(e)}),t.sort()},hasProperty:function(e,t){return null!==e&&"object"==typeof e&&t in e},invert:function(e){var t={};return $.isPlainObject(e)&&!$.isEmptyObject(e)&&$.each(e,function(e,n){$.isArray(n)||$.isPlainObject(n)||$.isFunction(n)||(t[n]=e)}),t},js_function:function(e){var t=this,n=1,i=[];for(n;n<arguments.length;n++)i.push(t.lookup(t.rec,arguments[n]));return t[e].apply(t,i)},lookup:function(e,t){var n=this,i="";if(e.hasOwnProperty(t))i=e[t];else if(t.indexOf(".")>0)for(var r=e,a=t.split("."),o=0;null!==r&&o<a.length;)o===a.length-1&&n.hasProperty(r,a[o])&&(i=r[a[o]]),r=r[a[o++]];else n.hasProperty(e,t)&&(i=e[t]);return i},lower:function(e){return String(e).toLowerCase()},make:function(e){var t=this;if(!e||!t.html)throw new Error("wui-smarty.js - Template engine missing data and/or html template.");if(t.rec=e,null===t.compiled){var n=t.parse();return t.compiled=t.compile(),n}return t.compiled.call(t,e)},parse:function(){var e,t=this,n=0,i=t.html;return i=e=i.replace(/{\*[\w\s.,\/#!$%\^&\*;:{}=\-_`~()\[\]@]*\*}/g,""),i=i.replace(/{([\w+|:\. '"-]+)}/g,function(i,r,a){var o=r.split("|"),l=o.shift(),s="";return t.build.push(e.substr(n,a-n)),n=a+r.length+2,t.build.push({key:l}),s=t.lookup(t.rec,l),s=t.applyFlags(s,o)}),t.build.push(e.substr(n)),i},trimSpecial:function(e,t,n){if(n=n||"g","string"!=typeof e||"string"!=typeof t||"string"!=typeof n)throw new TypeError("argument must be string");if(!/^[gi]*$/.test(n))throw new TypeError("wui-smarty.js - Invalid regex flags supplied '"+n.match(new RegExp("[^gi]*"))+"'");return t=t.replace(/[\[\](){}?*+\^$\\.|\-]/g,"\\$&"),e.replace(new RegExp("^["+t+"]+|["+t+"]+$",n),"")},unescape:function(e,t){return this.escape(e,t,!0)},upper:function(e){return String(e).toUpperCase()}},Wui.Combo2=function(e,t){$.extend(this,{autoLoad:!1,ddCls:"",attr:{},emptyMsg:"No Results.",field:$("<input>").attr({type:"text",autocomplete:"off",autocorrect:"off",autocapitalize:"off",spellcheck:"false"}).addClass("wui-combo-search"),hiddenCls:"wui-hidden",minKeys:1,placeholder:"",searchArgName:"filter",searchLocal:!0,searchThreshold:0,selected:[],showOpenButton:!0,template:null,templateFn:{},titleItem:null,valueItem:null},e,{multiSelect:!1}),this.init(t)},Wui.Combo2.prototype=$.extend(new Wui.Data,{addToDOM:function(e,t){var n=this,i=["append","prepend","before","after"];return("undefined"==typeof t||"undefined"==typeof e)&&$.each(i,function(i,r){return"undefined"!=typeof n[r]?(t=r,e=n[r],!1):void 0}),"undefined"==typeof t&&(t="append"),"undefined"==typeof e&&(e="body"),$(e)[t](n.el),n.cssByParam(),n.el},adjustDropDownSize:function(){var e,t=this,n=0;t.ddCSSRetrieved!==!0&&(t.ddWidthStyle=Wui.getStylesForElement(t.dd[0]).width,t.ddCSSRetrieved=!0),t._open||t.dd.css({visibility:"hidden"}).removeClass(t.hiddenCls),t.dd.css({width:""}),isNaN(parseInt(t.ddWidthStyle))&&0!==String(t.ddWidthStyle).indexOf("calc")&&(e=t.el.innerWidth()<100?100:t.el.innerWidth(),n=t.dd.outerWidth()+Wui.getScrollbarWidth(),e=e>n?e:n,t.dd.width(e)),t._open||t.dd.addClass(t.hiddenCls)},argsByParam:function(){var e=this,t={},n={id:"id",name:"name",tabindex:"tabIndex",lang:"lang",title:"titleAttr"};$.each(n,function(n,i){var r=e[i];("string"==typeof r||"number"==typeof r)&&("name"==n?e.selectTag.attr(n,r):t[n]=r)}),e.field.attr(t)},attachToElement:function(e){var t=this;t.selectObserver($(e)),e.on({change:function(){t.val(e.val(),!1)}}),t.el.on("valchange",function(n,i,r){var a,o=function(){return null===r?(a=t.getItemBy(t.valueItem,r),"undefined"==typeof a?"":r):$.isPlainObject(r)?r[t.valueItem]:r}();e.val(o)})},buildComboFromSelect:function(){var e=this;e.selectTag.after(e.el).addClass(e.hiddenCls).prependTo(e.el),e.attachToElement(e.selectTag),e.cssByParam(),e.valueItem="value",e.titleItem="label",e.template||(e.engine.html=e.template="<li>{label}</li>"),e.setData(Wui.parseSelect(e.selectTag)),e.val(e.selectTag.val(),!1)},buildComboFromJS:function(){var e=this;if((!e.hasOwnProperty("template")||null===e.template||void 0===e.template)&&e.hasOwnProperty("valueItem")&&e.hasOwnProperty("titleItem")&&e.valueItem&&e.titleItem&&(e.engine.html=e.template="<li>{"+e.titleItem+"|escape:html}</li>"),!e.template)throw new Error("Wui.js - valueItem and titleItem, or template, are required configs for a Combo.");e.addToDOM(),e.getSrcData()},close:function(){var e=this;e._open===!0&&(e.lockBodyScroll(),e._open=!1,e.dd.addClass(e.hiddenCls),void 0!==e.isBlurring&&(e.isBlurring=!0,e.field.focus().select()))},createOptionListToggle:function(){var e,t=this;return t.showOpenButton?(e=$("<button>",{unselectable:"on",tabindex:-1}).addClass("wui-button drop-down-switch").html("").on({mousedown:function(){t.field.is(":focus")&&(t.isBlurring=!1)},click:function(e){e.preventDefault(),e.stopPropagation(),t._open===!0?t.close():t.field.mousedown()}}),t.el.addClass("wui-has-dd-btn"),e):void 0},cssByParam:function(){var e,t=this,n=t.el,i={};return t.argsByParam(),$.isEmptyObject(t.attr)||n.attr(t.attr),$.isNumeric(t.height)&&t.height>=0&&$.extend(i,{height:t.height}),$.isNumeric(t.width)&&t.width>=0&&$.extend(i,{width:t.width,flex:"none"}),Wui.isPercent(t.width)&&(e=Wui.percentToPixels(n,t.width,"width"),0!==e&&$.extend(i,{width:e,flex:"none"})),Wui.isPercent(t.height)&&(e=Wui.percentToPixels(n,t.height,"height"),0!==e&&$.extend(i,{height:e})),t.hidden&&$.extend(i,"display","none"),n.addClass(t.cls).css(i)},dataChanged:function(){this.make()},each:function(e,t){var n=this,i=0,r=n.items||n;if(!$.isArray(r))return!1;if(t!==!1)for(i;i<r.length&&e(r[i],i)!==!1;i++);else for(i=r.length;i>=0&&e(r[i],i)!==!1;i--);return!0},getItemBy:function(e,t){var n,i=this;return i.each(function(i){return void 0!==i.rec[e]&&i.rec[e]===t?(n=i,!1):void 0}),n},getSrcData:function(){var e=this;return e.initLoaded!==!0&&$.isArray(e.data)&&e.data.length>0?(e.setParams(e.params),e.initLoaded=!0,e.setData(e.data)):e.autoLoad?null!==this.url?e.loadData():e.setData(e.data):void 0},getVal:function(){var e=this,t=$.isPlainObject(e.value)&&"undefined"!=typeof e.value[e.valueItem]?e.value[e.valueItem]:e.value;return t},hilightText:function(e){function t(e){return e.find("."+a).each(function(){$(this).replaceWith($(this).html())}).end()}function n(t){return t.replace(new RegExp(e,"ig"),function(e){return'<span class="'+a+'">'+e+"</span>"})}function i(e){if(t(e),e.children().length){var r=e.contents().filter(function(){return 3==this.nodeType&&this.nodeValue.replace(/^\s+|\s+$/g,"").length>0})[0];r&&$(r).replaceWith($.parseHTML(n(r.nodeValue))),e.children().each(function(){i($(this))})}else e.html(n(e.text()));return e}var r=this,a="wui-highlight";"undefined"!=typeof e&&0!==$.trim(e).length?(r.dd.find(".wui-optgroup-label."+r.hiddenCls).removeClass(r.hiddenCls),r.searchHTMLText(e,function(e){i(e).removeClass(r.hiddenCls)},function(e){t(e).addClass(r.hiddenCls)}),r.dd.children(".wui-combo-disabled").addClass(r.hiddenCls),r.dd.children(".wui-optgroup-label").each(function(){var e=$(arguments[1]);0===e.children("ul").children(":visible").length&&e.addClass(r.hiddenCls)})):(r.dd.find("."+r.hiddenCls).removeClass(r.hiddenCls),r.dd.find("."+a).each(function(){$(this).replaceWith($(this).html())})),Wui.positionItem(r.el,r.dd)},init:function(e){var t=this;t.selectTag="undefined"!=typeof e?$(e):void 0,$.extend(t,{el:$("<div>").addClass("wui-form-field").append(t._setListeners()),engine:new Wui.Smarty($.extend({html:t.template},t.templateFn)),idCls:t.selectTag?Wui.id(t.selectTag.attr("name")):Wui.id(),items:[],multiSelect:t.multiSelect===!0||t.selectTag&&t.selectTag.prop("multiple")===!0,searchLocal:null===t.url||t.autoLoad===!0,value:t.hasOwnProperty("value")?t.value:null}),$("body").append(t.dd=$("<ul>").addClass("wui-combo-dd "+t.hiddenCls+" "+t.ddCls)),t.setPlaceholder(t.placeholder),t.el.addClass("wui-combo "+t.idCls).append(t.createOptionListToggle()),t.selectTag?t.buildComboFromSelect():t.buildComboFromJS(),t.toggleFieldSearchability()},itemDeselect:function(e){var t=this;return t.selected.length>0?(e.el.removeClass("wui-selected"),t.selected=[],t.el.trigger($.Event("wuideselect"),[t,e.el,e.rec]).trigger($.Event("wuichange"),[t,e.el,e.rec,t.selected]),e):void 0},itemSelect:function(e,t){var n=this;return e&&(n.dd.find(".wui-selected").removeClass("wui-selected"),e.el.addClass("wui-selected"),n.selected=[e],n.multiSelect||t||n.el.trigger($.Event("wuiselect"),[n,e.el,e.rec]).trigger($.Event("wuichange"),[n,e.el,e.rec,n.selected])),e},loadData:function(){var e=this;return e.el.addClass("wui-loading"),Wui.Data.prototype.loadData.apply(e,arguments)},lockBodyScroll:function(e){var t,n=this,i=$("body"),r=$(window),a="wui-combo-no-scroll",o="resize.wui-combo2";return e===!0&&i.outerHeight(!0)>$.viewportH()?(i.css({top:-1*r.scrollTop(),width:i.width()}).addClass(a),r.on(o,function(){n.lockBodyScroll(),n.sizeAndPositionDD(),i.css({width:i.width()}),n.lockBodyScroll(!0)})):(t=-1*parseInt(i.css("top")),i.removeClass(a).css({top:"",width:""}),r.scrollTop(t).off(o)),i},make:function(){var e=this,t=$("<div>"),n={};return e.items=[],e.data.forEach(function(i){var r={el:$(e.engine.make(i)),rec:i};e.items.push(r),i.disabled!==!0?e.optionEventListeners(r):r.el.addClass("wui-combo-disabled"),"undefined"!=typeof i.optgroup&&0!==String(i.optgroup).length?"undefined"!=typeof n[i.optgroup]?n[i.optgroup].find("ul").append(r.el):t.append(n[i.optgroup]=$('<li class="wui-optgroup-label">'+i.optgroup+'<ul class="wui-optgroup"></ul></li>').find("ul").append(r.el).end()):t.append(r.el)}),e.dd.empty().append(t.children().unwrap()).off("mousedown").on("mousedown",function(){e.isBlurring=!1}),0===e.data.length?e.dd.html(e.emptyMsg):e.hilightText(e.previous),e.sizeAndPositionDD(),e.el.removeClass("wui-loading"),e.items.length},notFound:function(){},optionEventListeners:function(e){var t=this;return e.el.data("itm",e).bind("touchstart",function(){t.itemSelect($(this).data("itm")),t.isBlurring=!1}).on({mousemove:function(e){e.stopPropagation(),"undefined"==typeof t.selected[0]&&t.itemSelect($(this).data("itm")),t.selected[0].el[0]!==this&&t.itemSelect($(this).data("itm"))},mousedown:function(e){e.stopPropagation(),t.isBlurring=!1},click:function(e){e.stopPropagation(),t.set(),t.close()}}),e},open:function(){var e=this;e._open||(e._open=!0,e.lockBodyScroll(!0),$(document).one("click:"+e.idCls,"*:not(."+e.idCls+" input)",function(t){t.target!==e.field[0]&&(e.setVal(e.value),e.close())}),e.sizeAndPositionDD(),e.field.focus().select())},scrollToCurrent:function(){var e=this,t=e.dd.find(".wui-selected:first"),n=t.offsetParent(),i=function(){var n=0;return t.prevAll().each(function(){n+=$(this).outerHeight()}),n-=e.dd.height()/2-t.outerHeight()/2}();n.animate({scrollTop:i},100)},searchData:function(){var e=this,t=$.trim(e.field[0].value),n=e.previous||void 0,i={};e.previous=t,e.searchLocal?e.hilightText(t):(t.length>=e.minKeys||0===t.length)&&e.previous!=n&&(i[e.searchArgName]=t,e.loadData(i))},searchHTMLText:function(e,t,n){var i=this,r=i.items.map(function(e){return e.el});i.each.call(r,function(i){return i.text().toUpperCase().indexOf(e.toUpperCase())>=0&&"function"==typeof t?t(i):"function"==typeof n?n(i):void 0})},selectAjacent:function(e){var t,n,i=this,r=i.items.map(function(e){return e.rec.disabled!==!0&&e.el.is(":visible")?e.el:void 0}).filter(function(e){return void 0!==e}),a=function(e){var t;return e.length>0&&r.forEach(function(n,i){return n[0]===e[0].el[0]?(t=i,!1):void 0}),t}(i.selected),o=e>0?0:r.length-1;i.justOpened===!0&&(e=0,i.justOpened=!1),n=$.isNumeric(a)?r[a+e]:r[o],t=i.selectByEl(n),$.isPlainObject(t)||(t=i.selectByEl(r[o]))},selectBy:function(){var e=this,t=e.getItemBy.apply(e,arguments);return e.itemSelect(t)},selectByEl:function(e,t){var n,i=this;return i.itemSelect(n=$(e).data("itm")),t!==!1&&i.scrollToCurrent(),n},selectCurrent:function(){var e,t=this;t.value&&0===t.field.val().length&&(e=t.selectBy(t.valueItem,t.value)),"undefined"==typeof e&&$.isPlainObject(t.value)&&(e=t.selectBy(t.valueItem,t.value[t.valueItem])),"undefined"!=typeof e?t.set():t.notFound()},selectObserver:function(e){function t(){var t=e[0],i=0!==~~t.option_count?t.option_count:e.find("option").length;n.selectTag&&i!=n.total&&n.setData(Wui.parseSelect(n.selectTag)),t.observer_count=~~++t.observer_count,t.observer_count+1==i&&(t.observer_count=0,setTimeout(function(){e.trigger("change")},0))}var n=this;return e.find("option").each(function(e,n){Object.defineProperty(n,"selected",{get:function(){return this.getAttribute("selected")},set:function(e){e===!1?n.removeAttribute("selected"):n.disabled!==!0&&n.setAttribute("selected",!0),t()}})}),Object.defineProperty(e[0],"value",{get:function(){return $.valHooks.select.get(this)},set:function(e){$.valHooks.select.set(this,e)}}),e},set:function(){var e=this,t=e.selected[0];t&&(e.value!==t.rec&&e.val(t.rec),t.rec.disabled!==!0?(e.field.val(t.rec[e.titleItem]),e.setPlaceholder(""),e.toggleFieldSearchability()):e.setPlaceholder(t.rec[e.titleItem])),e._open&&e.close()},_setChanged:function(e){var t=this;t.parent&&t.parent instanceof Wui.Form&&t.parent.formChange(!0,t),t.el.trigger($.Event("valchange"),[t,t.value,e])},_setListeners:function(){var e=this,t={TAB:9,ENTER:13,SHIFT:16,ESC:27,UP:38,DOWN:40};return e.field.on("keydown",function(n){if(n.stopPropagation(),e.items.length<e.searchThreshold&&e.searchLocal&&n.keyCode!=t.TAB&&n.preventDefault(),n.keyCode==t.SHIFT)return!1;if(n.keyCode==t.TAB)e._open||e.set();else if(n.keyCode!=t.SHIFT&&(e._open||(e.justOpened=!0),e.open()),-1!=$.inArray(n.keyCode,[t.DOWN,t.UP,t.ENTER,t.ESC]))switch(n.preventDefault(),e.can_search=!1,n.keyCode){case t.DOWN:e.selectAjacent(1);break;case t.UP:e.selectAjacent(-1);break;case t.ENTER:e.set();break;case t.ESC:e.close()}else e.can_search=!0}).on("keyup",function(n){var i=null;n.stopPropagation(),n.keyCode==t.ENTER&&(n.preventDefault(),e.set()),e.can_search&&-1==$.inArray(n.keyCode,[t.TAB,t.SHIFT])&&(e.total>=e.searchThreshold||!e.searchLocal?e.searchData():0===n.which||n.ctrlKey||n.metaKey||n.altKey||(i=String.fromCharCode(n.which),"undefined"==typeof e.selectTypeBuffer?(e.selectTypeBuffer=i,setTimeout(function(){e.selectTypeBuffer=void 0},1e3)):e.selectTypeBuffer+=i,e.searchHTMLText(e.selectTypeBuffer,function(t){e.selectByEl(t)})))}).on("focus",function(t){t.stopPropagation(),e.isBlurring!==!0&&(e.selectTag&&void 0===e.isBlurring&&e.selectTag.triggerHandler("focus"),e.isBlurring=void 0,e.el.addClass("wui-fe-focus"))}).on("blur",function(){e.isBlurring!==!1&&(e.close(),e.isBlurring=void 0,e.el.removeClass("wui-fe-focus"))}).on("mousedown",function(t){$(this).is(":focus")||t.preventDefault(),e.open()})},setPlaceholder:function(e){var t=this;return t.placeholder=e,t.field.attr("placeholder",e),e},setVal:function(e){var t=this,n=$.isPlainObject(e)?e[t.valueItem]:e,i=t.selectBy(t.valueItem,n);return $.isPlainObject(i)?(t.value=i.rec,t.set(),i):void 0},sizeAndPositionDD:function(){var e=this;e.dd.css({visibility:"hidden"}).removeClass(e.hiddenCls),e.adjustDropDownSize(),Wui.positionItem(e.el,e.dd),e.dd.css("visibility",""),$.isPlainObject(e.value)&&(e.getItemBy(e.valueItem,e.value[e.valueItem]),e.scrollToCurrent())},toggleFieldSearchability:function(){var e=this,t=e.items.length>=e.searchThreshold||!e.searchLocal,n=0===e.selected.length||0===e.field.val().length;t&&n?(e.el.addClass("wui-combo-searchable"),e.field.prop("readonly",!1)):(e.el.removeClass("wui-combo-searchable"),t||e.field.prop("readonly",!0))},val:function(){var e=this;if(arguments.length){var t=e.value;return e.setVal.apply(e,arguments),arguments[1]!==!1&&e._setChanged(t),arguments}return e.getVal()}});